<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
  <title>arc-onboarding test</title>

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
  <script src="../../../mocha/mocha.js"></script>
  <script src="../../../chai/chai.js"></script>
  <script src="../../../wct-mocha/wct-mocha.js"></script>

  <script src="../../../web-animations-js/web-animations-next.min.js"></script>
</head>
<body>
  <test-fixture id="Basic">
    <template>
      <onboarding-tutorial id="test">
        <onboarding-page>test</onboarding-page>
        <onboarding-page>test</onboarding-page>
      </onboarding-tutorial>
    </template>
  </test-fixture>

  <test-fixture id="Opened">
    <template>
      <onboarding-tutorial id="test" opened>
        <onboarding-page>test</onboarding-page>
        <onboarding-page>test</onboarding-page>
      </onboarding-tutorial>
    </template>
  </test-fixture>

  <test-fixture id="Delay">
    <template>
      <onboarding-tutorial id="test" delay="20" auto>
        <onboarding-page>test</onboarding-page>
        <onboarding-page>test</onboarding-page>
      </onboarding-tutorial>
    </template>
  </test-fixture>

  <test-fixture id="DelayBasic">
    <template>
      <onboarding-tutorial id="test" delay="1">
        <onboarding-page>test</onboarding-page>
        <onboarding-page>test</onboarding-page>
      </onboarding-tutorial>
    </template>
  </test-fixture>

  <test-fixture id="Empty">
    <template>
      <onboarding-tutorial id="test"></onboarding-tutorial>
    </template>
  </test-fixture>
  <script type="module">
  import sinon from '../../../sinon/pkg/sinon-esm.js';
  import '../onboarding-tutorial.js';
  import '../onboarding-page.js';
  suite('Initialization', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Basic');
      flush(() => done());
    });

    test('pages are computed', function() {
      assert.lengthOf(element.pages, 2);
    });

    test('selectedPage is 0 by default', function() {
      assert.equal(element.selectedPage, 0);
    });

    test('previousEnabled false', function() {
      assert.isFalse(element.previousEnabled);
    });

    test('lastPage false', function() {
      assert.isFalse(element.lastPage);
    });

    test('nextLabel false', function() {
      assert.equal(element.nextLabel, 'Next');
    });

    test('showSkip is true by default', function() {
      assert.isTrue(element.showSkip);
    });

    test('noPagination is computed', function() {
      assert.isFalse(element.noPagination);
    });

    test('renderPrev is computed', function() {
      assert.isTrue(element.renderPrev);
    });

    test('Displays next page', function() {
      element.next();
      assert.equal(element.selectedPage, 1);
      assert.isTrue(element.lastPage);
      assert.equal(element.nextLabel, 'Close');
      assert.isFalse(element.showSkip);
    });
  });

  suite('_checkTutorialOpen()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Basic');
      flush(() => done());
    });

    test('Does nothing when no auto', () => {
      element._checkTutorialOpen();
      assert.isUndefined(element._openedChecked);
    });

    test('Does nothing when _openedChecked is set', () => {
      element._openedChecked = true;
      const spy = sinon.spy(element, 'openTutorial');
      element._checkTutorialOpen();
      assert.isFalse(spy.called);
    });

    test('Calls openTutorial()', () => {
      element.auto = true;
      element.delay = undefined;
      const spy = sinon.spy(element, 'openTutorial');
      element._checkTutorialOpen();
      assert.isTrue(spy.called);
    });

    test('Calls openTutorial() delayed', (done) => {
      element.auto = true;
      element.delay = 1;
      const spy = sinon.spy(element, 'openTutorial');
      element._checkTutorialOpen();
      setTimeout(() => {
        assert.isTrue(spy.called);
        done();
      });
    });
  });

  suite('_processNewNodes()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Empty');
      flush(() => done());
    });

    test('Does nothing when no argument', () => {
      element._processNewNodes();
      assert.lengthOf(element.pages, 0);
    });

    test('Filters out non-element nodes', () => {
      element._processNewNodes([document.createTextNode('test')]);
      assert.lengthOf(element.pages, 0);
    });

    test('Sets pages', () => {
      element._processNewNodes([document.createElement('div')]);
      assert.lengthOf(element.pages, 1);
    });

    test('Adds to pages', () => {
      element.pages = [{}];
      element._processNewNodes([document.createElement('div')]);
      assert.lengthOf(element.pages, 2);
    });
  });

  suite('_processRemovedNodes()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Basic');
      flush(() => done());
    });

    test('Does nothing when no argument', () => {
      element._processRemovedNodes();
      assert.lengthOf(element.pages, 2);
    });

    test('Filters out non-element nodes', () => {
      element._processRemovedNodes([document.createTextNode('test')]);
      assert.lengthOf(element.pages, 2);
    });

    test('Resets pages array', () => {
      element._processRemovedNodes([element.querySelector('onboarding-page')]);
      assert.lengthOf(element.pages, 1);
    });

    test('Ignores unknown nodes', () => {
      element._processRemovedNodes([document.createElement('div')]);
      assert.lengthOf(element.pages, 2);
      // no error + coverage
    });

    test('Ignores when no pages', () => {
      element.pages = undefined;
      element._processRemovedNodes([document.createElement('div')]);
      assert.isUndefined(element.pages);
      // no error + coverage
    });
  });

  suite('openTutorial()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('DelayBasic');
      flush(() => done());
    });

    test('Enetually opens the tutorial', () => {
      return element.openTutorial()
      .then(() => {
        assert.isTrue(element.opened);
      });
    });

    test('Dispatches tutorial-open event', () => {
      const spy = sinon.spy();
      element.addEventListener('tutorial-open', spy);
      return element.openTutorial()
      .then(() => {
        assert.isTrue(spy.called);
      });
    });

    test('Won\'t open tutorial if already finished', () => {
      localStorage.setItem('tutorial_test', 'true');
      return element.openTutorial()
      .then(() => {
        assert.isFalse(element.opened);
      });
    });
  });

  suite('_computeShowPrevious()', () => {
    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns true when argument is greater than 0', () => {
      const result = element._computeShowPrevious(1);
      assert.isTrue(result);
    });

    test('Casts argument to a number', () => {
      const result = element._computeShowPrevious('1');
      assert.isTrue(result);
    });

    test('Returns false when 01', () => {
      const result = element._computeShowPrevious(0);
      assert.isFalse(result);
    });
  });

  suite('next()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('DelayBasic');
      flush(() => done());
    });

    test('Calls selectNext()', () => {
      const spy = sinon.spy(element.$.pages, 'selectNext');
      element.next();
      assert.isTrue(spy.called);
    });

    test('Calls completeTutorial() when last page', () => {
      element.selectedPage = 1;
      const spy = sinon.spy(element, 'completeTutorial');
      element.next();
      assert.isTrue(spy.called);
    });
  });

  suite('prev()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('DelayBasic');
      flush(() => done());
    });

    test('Calls selectPrevious()', () => {
      const spy = sinon.spy(element.$.pages, 'selectPrevious');
      element.prev();
      assert.isTrue(spy.called);
    });
  });

  suite('completeTutorial()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Opened');
      flush(() => done());
    });

    test('Calls close() only when no id', () => {
      const spy1 = sinon.spy(element, 'close');
      const spy2 = sinon.spy(element, '_saveTutorialPassed');
      element.id = '';
      element.completeTutorial();
      assert.isTrue(spy1.called);
      assert.isFalse(spy2.called);
    });

    test('Calls both functions', () => {
      const spy1 = sinon.spy(element, 'close');
      const spy2 = sinon.spy(element, '_saveTutorialPassed');
      element.completeTutorial();
      assert.isTrue(spy1.called);
      assert.isTrue(spy2.called);
    });

    test('Dispatches tutorial-close event', () => {
      const spy = sinon.spy();
      element.addEventListener('tutorial-close', spy);
      element.completeTutorial();
      assert.isTrue(spy.called);
    });
  });

  suite('skip()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Opened');
      flush(() => done());
    });

    test('Calls completeTutorial()', () => {
      const spy = sinon.spy(element, 'completeTutorial');
      element.skip();
      assert.isTrue(spy.called);
    });

    test('Dispatches send-analytics event', () => {
      const spy = sinon.spy();
      element.addEventListener('send-analytics', spy);
      element.skip();
      assert.isTrue(spy.called);
    });
  });

  suite('_tutorialId()', () => {
    let element;
    setup((done) => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Opened');
      flush(() => done());
    });

    test('Returns undefined when no id', () => {
      element.id = '';
      const result = element._tutorialId();
      assert.isUndefined(result);
    });

    test('Returns id', () => {
      const result = element._tutorialId();
      assert.equal(result, 'tutorial_test');
    });
  });

  suite('_getTutorialState()', () => {
    let element;
    setup(() => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Basic');
    });

    test('Eventually returns false when no id', () => {
      element.id = '';
      return element._getTutorialState()
      .then((result) => {
        assert.isFalse(result);
      });
    });

    test('Eventually returns false when no status', () => {
      return element._getTutorialState()
      .then((result) => {
        assert.isFalse(result);
      });
    });

    test('Eventually returns true when has status', () => {
      localStorage.setItem('tutorial_test', 'true');
      return element._getTutorialState()
      .then((result) => {
        assert.isTrue(result);
      });
    });
  });

  suite('_saveTutorialPassed()', () => {
    let element;
    setup(() => {
      localStorage.removeItem('tutorial_test');
      element = fixture('Basic');
    });

    test('Does nothing when no id', () => {
      element.id = '';
      return element._saveTutorialPassed();
      // for coverage
    });

    test('Sets data in the store', () => {
      return element._saveTutorialPassed()
      .then(() => {
        const value = localStorage.getItem('tutorial_test');
        assert.equal(value, 'true');
      });
    });
  });

  suite('__getStateChrome()', () => {
    suiteSetup(() => {
      if (!window.chrome) {
        window.chrome = {};
      }
      if (!window.chrome.storage) {
        window.chrome.storage = {};
      }
      if (!window.chrome.storage.sync) {
        window.chrome.storage.sync = {};
      }
      window.chrome.storage.sync.get = (key, clb) => {
        if (!key) {
          clb();
          return;
        }
        const result = {};
        result[key] = key === 'empty' ? null : 'true';
        clb(result);
      };
    });

    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Retuerns false when has no result', () => {
      return element.__getStateChrome()
      .then((result) => {
        assert.isFalse(result);
      });
    });

    test('Retuerns false when has no key', () => {
      return element.__getStateChrome('empty')
      .then((result) => {
        assert.isFalse(result);
      });
    });

    test('Retuerns false when has key', () => {
      return element.__getStateChrome('tutorial')
      .then((result) => {
        assert.isTrue(result);
      });
    });
  });

  suite('__setStateChrome()', () => {
    suiteSetup(() => {
      if (!window.chrome) {
        window.chrome = {};
      }
      if (!window.chrome.storage) {
        window.chrome.storage = {};
      }
      if (!window.chrome.storage.sync) {
        window.chrome.storage.sync = {};
      }
      window.chrome.storage.sync.set = (key, clb) => {
        clb();
      };
    });

    let element;
    setup(() => {
      element = fixture('Basic');
    });

    test('Returns a promise', () => {
      return element.__setStateChrome();
    });
  });
  </script>
</body>
</html>
